# https://github.com/Fndroid/clash_for_windows_pkg/issues/2193#issuecomment-1589107746
parsers: # array
  - reg: ^.*$
    code: |
      module.exports.parse = (raw, { yaml }) => {
        const rawObj = yaml.parse(raw)
        const groups = []
        const rules = []
        return yaml.stringify({ ...rawObj, 'proxy-groups': groups, rules })
      } 
    yaml:
      prepend-proxy-groups: # å»ºç«‹ç­–ç•¥ç»„
        - name: ðŸ”¯ ä»£ç†æ¨¡å¼ 
          type: select
          proxies:
            - ç™½åå•ä¸¨ä¸å‘½ä¸­åˆ™ä»£ç†(Whitelist) # ç™½åå•æ¨¡å¼ï¼Œæ„ä¸ºã€Œæ²¡æœ‰å‘½ä¸­è§„åˆ™çš„ç½‘ç»œæµé‡ï¼Œç»Ÿç»Ÿä½¿ç”¨ä»£ç†ã€
            - é»‘åå•ä¸¨ä¸å‘½ä¸­åˆ™ç›´è¿ž(GFWlist) # é»‘åå•æ¨¡å¼ï¼Œæ„ä¸ºã€Œåªæœ‰å‘½ä¸­è§„åˆ™çš„ç½‘ç»œæµé‡ï¼Œæ‰ä½¿ç”¨ä»£ç†ã€

        - name: PROXY
          type: select
          proxies:
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ‰€æœ‰
            - ðŸ”° æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹é¦™æ¸¯
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ—¥æœ¬
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ç¾Žå›½

        - name: ðŸ¤– Ai
          type: select
          proxies:
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ç¾Žå›½
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ‰€æœ‰
            - DIRECT
            - REJECT
            - PROXY
            - ðŸ”° æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ—¥æœ¬    
            - ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹é¦™æ¸¯                     

        - name: ðŸ”° æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹ 
          type: select

        - name: ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ‰€æœ‰
          type: url-test
          url: http://www.google.com/generate_204
          interval: 300
          tolerance: 50

        - name: ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ—¥æœ¬ 
          type: url-test
          url: http://www.google.com/generate_204
          interval: 300
          tolerance: 50

        - name: ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ç¾Žå›½ 
          type: url-test
          url: http://www.google.com/generate_204
          interval: 300
          tolerance: 50

        - name: ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹é¦™æ¸¯
          type: url-test
          url: http://www.google.com/generate_204
          interval: 300
          tolerance: 50

        - name: ðŸ›‘ å¹¿å‘Šæ‹¦æˆª
          type: select
          proxies:
            - DIRECT
            - REJECT
            - PROXY

        - name: é»‘åå•ä¸¨ä¸å‘½ä¸­åˆ™ç›´è¿ž(GFWlist)
          type: select
          proxies:
            - DIRECT
            
        - name: ç™½åå•ä¸¨ä¸å‘½ä¸­åˆ™ä»£ç†(Whitelist)
          type: select
          proxies:
            - PROXY
            
  # ç­–ç•¥ç»„ç¤ºä¾‹
       # - name: åˆ†ç»„å
         # type: select       # æ‰‹åŠ¨é€‰ç‚¹   
               # url-test     # è‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä½Žçš„èŠ‚ç‚¹
               # fallback     # èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ª
               # laod-balance # å‡è¡¡ä½¿ç”¨åˆ†ç»„å†…çš„èŠ‚ç‚¹
         # url: http://www.gstatic.com/generate_204 # æµ‹è¯•åœ°å€ éžselectç±»åž‹åˆ†ç»„å¿…è¦
         # interval: 300 # è‡ªåŠ¨æµ‹è¯•é—´éš”æ—¶é—´ï¼Œå•ä½ç§’ éžselectç±»åž‹åˆ†ç»„å¿…è¦
         # tolerance: 50 # å…è®¸çš„åå·®ï¼ŒèŠ‚ç‚¹ä¹‹é—´å»¶è¿Ÿå·®å°äºŽè¯¥å€¼ä¸åˆ‡æ¢ éžå¿…è¦
         # proxies:  
           # - èŠ‚ç‚¹åç§°æˆ–å…¶ä»–åˆ†ç»„å¥—å¨ƒ
          
      commands:
        - proxy-groups.ðŸ”° æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹.proxies=[]proxyNames|^((?!å®˜ç½‘|æš‚æ—¶|è´­ä¹°æ¸ é“|IPV6).)*$ # å‘æŒ‡å®šç­–ç•¥ç»„æ·»åŠ è®¢é˜…ä¸­çš„èŠ‚ç‚¹åï¼Œå¯ä½¿ç”¨æ­£åˆ™è¿‡æ»¤
        - proxy-groups.ðŸ”° æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹.proxies.0+DIRECT # å‘æŒ‡å®šåˆ†ç»„ç¬¬ä¸€ä¸ªä½ç½®æ·»åŠ ä¸€ä¸ª DIRECT èŠ‚ç‚¹å
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ‰€æœ‰.proxies=[]proxyNames|^((?!å®˜ç½‘|æš‚æ—¶|è´­ä¹°æ¸ é“|IPV6).)*$ # å‘æŒ‡å®šç­–ç•¥ç»„æ·»åŠ è®¢é˜…ä¸­çš„èŠ‚ç‚¹åï¼Œå¯ä½¿ç”¨æ­£åˆ™è¿‡æ»¤
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ‰€æœ‰.proxies.0+DIRECT # å‘æŒ‡å®šåˆ†ç»„ç¬¬ä¸€ä¸ªä½ç½®æ·»åŠ ä¸€ä¸ª DIRECT èŠ‚ç‚¹å
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ—¥æœ¬.proxies=[]proxyNames|æ—¥æœ¬ # å‘æŒ‡å®šç­–ç•¥ç»„æ·»åŠ è®¢é˜…ä¸­çš„èŠ‚ç‚¹åï¼Œå¯ä½¿ç”¨æ­£åˆ™è¿‡æ»¤  
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹æ—¥æœ¬.proxies.0+DIRECT # å‘æŒ‡å®šåˆ†ç»„ç¬¬ä¸€ä¸ªä½ç½®æ·»åŠ ä¸€ä¸ª DIRECT èŠ‚ç‚¹å                   
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ç¾Žå›½.proxies=[]proxyNames|ç¾Žå›½ # å‘æŒ‡å®šç­–ç•¥ç»„æ·»åŠ è®¢é˜…ä¸­çš„èŠ‚ç‚¹åï¼Œå¯ä½¿ç”¨æ­£åˆ™è¿‡æ»¤ 
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ç¾Žå›½.proxies.0+DIRECT # å‘æŒ‡å®šåˆ†ç»„ç¬¬ä¸€ä¸ªä½ç½®æ·»åŠ ä¸€ä¸ª DIRECT èŠ‚ç‚¹å                  
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹é¦™æ¸¯.proxies=[]proxyNames|^(.*)(é¦™æ¸¯)+(.*)$ # å‘æŒ‡å®šç­–ç•¥ç»„æ·»åŠ è®¢é˜…ä¸­çš„èŠ‚ç‚¹åï¼Œå¯ä½¿ç”¨æ­£åˆ™è¿‡æ»¤  
        - proxy-groups.ðŸ”° è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹é¦™æ¸¯.proxies.0+DIRECT # å‘æŒ‡å®šåˆ†ç»„ç¬¬ä¸€ä¸ªä½ç½®æ·»åŠ ä¸€ä¸ª DIRECT èŠ‚ç‚¹å
        # ä¸€äº›å¯èƒ½ç”¨åˆ°çš„æ­£åˆ™è¿‡æ»¤èŠ‚ç‚¹ç¤ºä¾‹ï¼Œä½¿åˆ†ç»„æ›´ç»†è‡´
        # []proxyNames|a                         # åŒ…å«a
        # []proxyNames|^(.*)(a|b)+(.*)$          # åŒ…å«aæˆ–b
        # []proxyNames|^(?=.*a)(?=.*b).*$        # åŒ…å«aå’Œb
        # []proxyNames|^((?!b).)*a((?!b).)*$     # åŒ…å«aä¸”ä¸åŒ…å«b
        # []proxyNames|^((?!b|c).)*a((?!b|c).)*$ # åŒ…å«aä¸”ä¸åŒ…å«bæˆ–c
        
  # æ·»åŠ è§„åˆ™
      prepend-rules: # è§„åˆ™ç”±ä¸Šå¾€ä¸‹éåŽ†ï¼Œå¦‚ä¸Šé¢è§„åˆ™å·²ç»å‘½ä¸­ï¼Œåˆ™ä¸å†å¾€ä¸‹å¤„ç†
        - RULE-SET,Claude,ðŸ¤– Ai,no-resolve
        - RULE-SET,OpenAI,ðŸ¤– Ai,no-resolve
        - RULE-SET,Advertising,REJECT,no-resolve
        - RULE-SET,Lan,DIRECT,no-resolve
        - RULE-SET,Direct,DIRECT,no-resolve
        - RULE-SET,applications,DIRECT,no-resolve
        - RULE-SET,Global,PROXY,no-resolve
        - RULE-SET,GlobalMedia,PROXY,no-resolve
        - RULE-SET,ChinaMax,DIRECT,no-resolve
        - GEOIP,LAN,DIRECT,no-resolve
        - GEOIP,CN,DIRECT,no-resolve

        - MATCH,ðŸ”¯ ä»£ç†æ¨¡å¼ # è§„åˆ™ä¹‹å¤–çš„
  # æ·»åŠ è§„åˆ™é›†
      mix-rule-providers: 
          Claude:
            type: http
            behavior: classical
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.yaml"
            path: ./blackmatrix7/Claude.yaml
            interval: 86400
          OpenAI:
            type: http
            behavior: classical
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.yaml"
            path: ./blackmatrix7/OpenAI.yaml
            interval: 86400

          applications:
            type: http
            behavior: classical
            url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/applications.txt"
            path: ./ruleset/applications.yaml
            interval: 86400
          ChinaMax:
            type: http
            behavior: classical
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical.yaml"
            path: ./blackmatrix7/ChinaMax_Classical.yaml
            interval: 86400
          Lan:
            type: http
            behavior: classical
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan.yaml"
            path: ./blackmatrix7/Lan.yaml
            interval: 86400
          Direct:
            behavior: classical
            type: http
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Direct/Direct.yaml"
            interval: 86400
            path: ./blackmatrix7/Direct.yaml
          Advertising:
            behavior: classical
            type: http
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Advertising/Advertising.yaml"
            interval: 86400
            path: ./blackmatrix7/Advertising.yaml
          Global:
            behavior: classical 
            type: http
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global_Classical.yaml"
            interval: 86400
            path: ./blackmatrix7/Global.yaml
          GlobalMedia:
            behavior: classical 
            type: http
            url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical.yaml"
            interval: 86400
            path: ./blackmatrix7/GlobalMedia.yaml




  # https://github.com/Dreamacro/clash/issues/1385#issuecomment-1583996210
  # é¢„åŠ è½½rule-providers
  - reg: ^.*$
    code: |
      module.exports.parse = async (raw, { axios, yaml, console, homeDir }) => {
        const fs = require('fs');

        const rawObj = yaml.parse(raw);
        const providers = rawObj['rule-providers'];

        for (let provider in providers) {
          const obj = providers[provider];

          if (obj.type === 'file') {
              continue;
          }

          const ret = await axios({
              method: 'get',
              url: obj.url,
          });

          const fmt = obj.format === undefined || obj.format === 'yaml' ? 'yaml' : 'txt';
          const filePath = homeDir + '\\providers\\rule\\' + provider + '.' + fmt;
          fs.writeFileSync(filePath, ret.data);

          obj.type = 'file';
          obj.path = filePath;
          delete obj.url;
        }

        return yaml.stringify(rawObj);
      };